<!DOCTYPE html>
<html>
<head>
	<title>Trakt.tv movies ratings export to IMDb-like CSV</title>
	<style type="text/css">
	* {
		box-sizing: border-box;
	}
	html,
	body {
		margin: 0;
		height: 100%;
	}
	body {
		padding: 1em;
		font: 1em/1.2 monospace;
	}
	body, a {
		color: black;
	}
	#zone {
		margin: 0;
		padding: 1em;
		border: 1px solid silver;
		overflow: auto;
		height: 100%;
		word-break: break-all;
	}
	</style>
</head>
<body>
	<div id="zone">
		<p>Drop here a Trakt.tv backup file from <a href="http://eclectide.com/blog/2014/08/12/trakt-tv-backup">trakt-tv-backup</a> or any file containing IMDb IDs.
		<p>-> Get CSV data identical to ratings & watchlist files exported by IMDb, use-it to feed services asking for a IMDb export file (ex. <a href="https://icheckmovies.com">icheckmovies</a>, <a href="https://github.com/damienhaynes/TraktRater">TraktRater</a>).
		<p>Data is retrieved trough <a href="www.omdbapi.com">OMDb API</a>.
	</div>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
	<script type="text/javascript">

	var zone = document.getElementById('zone');
	var processedCount = 0;
	var data = {};

	function handleDrop(evt) {
		evt.stopPropagation();
		evt.preventDefault();

		var file = evt.dataTransfer.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			imdbify(e.target.result);
		};
      	reader.readAsText(file);
	}

	function handleDragOver(evt) {
		evt.stopPropagation();
		evt.preventDefault();
	}
	function selectText(element) {
	    var doc = document;

	    if (doc.body.createTextRange) { // ms
	        var range = doc.body.createTextRange();
	        range.moveToElementText(element);
	        range.select();
	    } else if (window.getSelection) { // moz, opera, webkit
	        var selection = window.getSelection();
	        var range = doc.createRange();
	        range.selectNodeContents(element);
	        selection.removeAllRanges();
	        selection.addRange(range);
	    }
	}


	function imdbify (ratings) {
		zone.innerHTML = 'IMDbify...';
		try {
			var json = JSON.parse(ratings);
			parseTraktBackupJSON(json);
		} catch(e) {
			parseGeneric(ratings);
		}

		for (id in data)
			httpGetAsync('https://www.omdbapi.com/?i='+id, httpCallback);
	}

	function parseTraktBackupJSON (json) {
		for (var i = 0; i < json.length; i++) {
			var entry = json[i],
				date = entry.rated_at || entry.last_watched_at;
			if(date && entry.movie)
				data[entry.movie.ids.imdb] = {
					position: i+1,
					created: moment(new Date(date)).format('ddd MMM D hh:mm:ss YYYY'),
					yourrating: entry.rating
				};
		};
	}
	function parseGeneric (content) {
		var ids = content.match(/tt\d+/g);
		var pos = 0;

		for (var i = 0; i < ids.length; i++) {
			var id = ids[i];
			if(ids.indexOf(id) != i) continue;
			data[id] = {
				position: ++pos,
				created: moment().format('ddd MMM D hh:mm:ss YYYY'),
				yourrating: ''
			};
		};
	}


	function httpGetAsync(theUrl, callback) {
	    var xmlHttp = new XMLHttpRequest();
	    xmlHttp.onreadystatechange = function() {
	        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
	            callback(xmlHttp.responseText);
	    }
	    xmlHttp.open("GET", theUrl, true);
	    xmlHttp.send(null);
	}
	function httpCallback(response) {
		processedCount++;
		response = JSON.parse(response);

		if(response.Error) return;

		for (var attr in response)
			data[response.imdbID][attr] = response[attr];

		// we got all the responses, let's finalize
		if(processedCount == Object.keys(data).length)
			finalize();
	}

	function finalize() {
		var csvoutput = '"position","const","created","modified","description","Title","Title type","Directors","You rated","IMDb Rating","Runtime (mins)","Year","Genres","Num. Votes","Release Date (month/day/year)","URL"';
		for (id in data) {
			var d = data[id];
			csvoutput += '<br>';
			csvoutput += '"' + d.position + '",';
			csvoutput += '"' + id + '",';
			csvoutput += '"' + d.created + '",';
			csvoutput += '"","",';
			csvoutput += '"' + d.Title + '",';
			csvoutput += '"Feature Film",';
			csvoutput += '"' + d.Director + '",';
			csvoutput += '"' + d.yourrating + '",';
			csvoutput += '"' + d.imdbRating + '",';
			if(d.Runtime)
				csvoutput += '"' + d.Runtime.replace(' min', '') + '",';
			csvoutput += '"' + d.Year + '",';
			csvoutput += '"' + d.Genre + '",';
			if(d.imdbVotes)
				csvoutput += '"' + d.imdbVotes.replace(',','') + '",';
			if(d.Released)
				csvoutput += '"' + moment(new Date(d.Released)).format('YYYY-MM-DD') + '",';
			csvoutput += '"http://www.imdb.com/title/' + id + '/"';
		};

		zone.innerHTML = csvoutput;
		selectText(zone);
	}


	zone.addEventListener('dragover', handleDragOver, false);
	zone.addEventListener('drop', handleDrop, false);
	</script>
</body>
</html>
